{
  "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion":"2.0",
  "contentVersion":"1.1.1.1",
  "apiProfile":"",
  "definitions":{},
  "parameters":{
    "env":{
      "defaultValue":"stg",
      "type":"String",
      "metadata":{
        "description":"Environment."
      }
    },
    "region_name":{
      "defaultValue":"[resourceGroup().location]",
      "type":"String",
      "metadata":{
        "description":"Region name."
      }
    },
    "virtual_network_name":{
      "defaultValue":"crm-vnet",
      "type":"String",
      "metadata":{
        "description":"Virtual network name."
      }
    },
    "virtual_network_subnet_name":{
      "defaultValue":"crm-vnet-bastion-sn-1",
      "type":"String",
      "metadata":{
        "description":"Virtual network subnet name."
      }
    },
    "network_security_group_name":{
      "defaultValue":"crm-nsg-bastion",
      "type":"String",
      "metadata":{
        "description":"Network security group name."
      }
    },
    "image_name":{
      "defaultValue":"sloopstash-base-v1.1.1-image",
      "type":"String",
      "metadata":{
        "description":"Image name."
      }
    }
  },
  "variables":{},
  "functions":[],
  "resources":{
    "crm_bastion_nic_1":{
      "apiVersion":"2021-05-01",
      "type":"Microsoft.Network/networkInterfaces",
      "name":"crm-bastion-nic-1",
      "location":"[parameters('region_name')]",
      "properties":{
        "ipConfigurations":[{
          "name":"ip_address_1",
            "properties":{
              "subnet":{
                "id":"[resourceId('Microsoft.Network/virtualNetworks/subnets',parameters('virtual_network_name'),parameters('virtual_network_subnet_name'))]"
              },
              "privateIPAllocationMethod":"Static",
              "privateIPAddress":"12.1.7.10",
              "privateIPAddressVersion":"IPv4",
              "publicIPAddress":{
                "id":"[resourceId('Microsoft.Network/publicIPAddresses','crm-bastion-pip')]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id":"[resourceId('Microsoft.Network/networkSecurityGroups',parameters('network_security_group_name'))]"
        }
      },
      "tags":{
        "Name":"crm-bastion-nic-1",
        "Environment":"[parameters('env')]",
        "Stack":"crm",
        "Region":"[parameters('region_name')]",
        "Organization":"sloopstash"
      }
    },
    "crm_bastion_vm_1":{
      "apiVersion":"2023-03-01",
      "type":"Microsoft.Compute/virtualMachines",
      "dependsOn":["crm_bastion_nic_1"],
      "name":"crm-bastion-vm-1",
      "location":"[parameters('region_name')]",
      "properties":{
        "hardwareProfile":{
          "vmSize":"Standard_B1s"
        },
        "storageProfile":{
          "osDisk":{
            "osType":"Linux",
            "name":"crm-bastion-disk-1",
            "createOption":"FromImage",
            "caching":"ReadWrite",
            "diskSizeGB":30,
            "managedDisk":{
              "storageAccountType":"Standard_LRS"
            },
            "deleteOption":"Delete"
          },
          "imageReference":{
            "id":"[resourceId('Microsoft.Compute/images',parameters('image_name'))]"
          }
        },
        "networkProfile":{
          "networkInterfaces":[{
            "id":"[resourceId('Microsoft.Network/networkInterfaces','crm-bastion-nic-1')]",
            "properties":{
              "deleteOption":"Delete"
            }
          }]
        },
        "osProfile":{
          "computerName":"crm-bastion-vm-1",
          "AdminUsername":"azureuser",
          "linuxConfiguration":{
            "disablePasswordAuthentication":true,
            "ssh":{
              "publicKeys":[{
                "path":"/home/azureuser/.ssh/authorized_keys",
                "keyData":"[reference(resourceId('Microsoft.Compute/sshPublicKeys','crm-ssh-key'),'2019-12-01').publicKey]"
              }]
            }
          }
        }
      },
      "tags":{
        "Name":"crm-bastion-vm-1",
        "Environment":"[parameters('env')]",
        "Stack":"crm",
        "Region":"[parameters('region_name')]",
        "Organization":"sloopstash"
      }
    }
  },
  "outputs":{}
}
