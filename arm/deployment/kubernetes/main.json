{
  "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion":"2.0",
  "contentVersion":"1.1.1.1",
  "apiProfile":"",
  "definitions":{},
  "parameters":{
    "environment":{
      "defaultValue":"prd",
      "type":"String",
      "metadata":{
        "description":"Environment."
      }
    },
    "ssh_public_key":{
      "type":"String",
      "metadata":{
        "description":"SSH public key."
      }
    }
  },
  "variables":{},
  "functions":[],
  "resources":{
    "kubernetes_vnet":{
      "apiVersion":"2024-05-01",
      "type":"Microsoft.Network/virtualNetworks",
      "name":"kubernetes-vnet",
      "location":"[resourceGroup().location]",
      "properties":{
        "addressSpace":{
          "addressPrefixes":["[if(equals(parameters('environment'),'prd'),'11.11.0.0/16','12.11.0.0/16')]"]
        },
        "encryption":{
          "enabled":true,
          "enforcement":"AllowUnencrypted"
        },
        "subnets":[{
          "type":"Microsoft.Network/virtualNetworks/subnets",
          "name":"kubernetes-vnet-bastion-sn-1",
          "properties":{
            "addressPrefixes":["[if(equals(parameters('environment'),'prd'),'11.11.1.0/24','12.11.1.0/24')]"]
          }
        },{
          "type":"Microsoft.Network/virtualNetworks/subnets",
          "name":"kubernetes-vnet-bastion-sn-2",
          "properties":{
            "addressPrefixes":["[if(equals(parameters('environment'),'prd'),'11.11.2.0/24','12.11.2.0/24')]"]
          }
        },{
          "type":"Microsoft.Network/virtualNetworks/subnets",
          "name":"kubernetes-vnet-aks-nd-sn-1",
          "properties":{
            "addressPrefixes":["[if(equals(parameters('environment'),'prd'),'11.11.9.0/24','12.11.9.0/24')]"]
          }
        },{
          "type":"Microsoft.Network/virtualNetworks/subnets",
          "name":"kubernetes-vnet-aks-nd-sn-2",
          "properties":{
            "addressPrefixes":["[if(equals(parameters('environment'),'prd'),'11.11.10.0/24','12.11.10.0/24')]"]
          }
        }]
      },
      "tags":{
        "Name":"kubernetes-vnet",
        "Environment":"[parameters('environment')]",
        "Stack":"kubernetes",
        "Region":"centralindia",
        "Organization":"sloopstash"
      }
    },
    "kubernetes_bastion_nsg":{
      "apiVersion":"2024-05-01",
      "type":"Microsoft.Network/networkSecurityGroups",
      "name":"kubernetes-bastion-nsg",
      "location":"[resourceGroup().location]",
      "properties":{
        "securityRules":[{
          "type":"Microsoft.Network/networkSecurityGroups/securityRules",
          "name":"AllowAnySSHInbound",
          "properties":{
            "direction":"Inbound",
            "access":"Allow",
            "priority":110,
            "protocol":"Tcp",
            "sourceAddressPrefix":"*",
            "sourcePortRange":"*",
            "destinationAddressPrefix":"*",
            "destinationPortRange":22
          }
        }]
      },
      "tags":{
        "Name":"kubernetes-bastion-nsg",
        "Environment":"[parameters('environment')]",
        "Stack":"kubernetes",
        "Region":"centralindia",
        "Organization":"sloopstash"
      }
    },
    "kubernetes_aks_ct":{
      "apiVersion":"2024-09-02-preview",
      "type":"Microsoft.ContainerService/managedClusters",
      "dependsOn":["kubernetes_vnet"],
      "name":"kubernetes-aks-ct",
      "location":"[resourceGroup().location]",
      "sku":{
        "name":"Base",
        "tier":"Free"
      },
      "identity":{
        "type":"SystemAssigned"
      },
      "properties":{
        "kubernetesVersion":"1.28.15",
        "dnsPrefix":"kubernetes-aks-ct-api-endpoint",
        "apiServerAccessProfile":{
          "enablePrivateCluster":false,
          "authorizedIPRanges":["0.0.0.0/0"],
          "disableRunCommand":false
        },
        "networkProfile":{
          "networkPlugin":"kubenet",
          "networkPolicy":"calico",
          "ipFamilies":["IPv4"],
          "loadBalancerSku":"standard"
        },
        "nodeResourceGroup":"kubernetes-aks-ct-rg",
        "agentPoolProfiles":[{
          "name":"nodepool1",
          "vmSize":"Standard_D2as_v4",
          "type":"VirtualMachineScaleSets",
          "osSKU":"AzureLinux",
          "vnetSubnetID":"[resourceId('Microsoft.Network/virtualNetworks/subnets','kubernetes-vnet','kubernetes-vnet-aks-nd-sn-1')]",
          "enableNodePublicIP":false,
          "enableUltraSSD":false,
          "enableEncryptionAtHost":false,
          "mode":"System",
          "orchestratorVersion":"1.28.15",
          "workloadRuntime":"OCIContainer",
          "enableAutoScaling":true,
          "maxCount":1,
          "minCount":1,
          "count":1,
          "maxPods":50
        }],
        "autoUpgradeProfile":{
          "upgradeChannel":"patch",
          "nodeOSUpgradeChannel":"NodeImage"
        },
        "enableRBAC":true,
        "enablePodSecurityPolicy":false,
        "securityProfile":{
          "imageCleaner":{
            "enabled":false
          }
        },
        "oidcIssuerProfile":{
          "enabled":false
        }
      },
      "tags":{
        "Name":"kubernetes-aks-ct",
        "Environment":"[parameters('environment')]",
        "Stack":"kubernetes",
        "Region":"centralindia",
        "Organization":"sloopstash"
      }
    }
  },
  "outputs":{
    "kubernetes_eks_ct_fqdn":{
      "type":"string",
      "value":"[reference(resourceId('Microsoft.ContainerService/managedClusters','kubernetes-aks-ct')).fqdn]"
    }
  }
}
